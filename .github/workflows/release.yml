name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  publish-npm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
          registry-url: https://registry.npmjs.org
      - run: npm ci
      - run: npm run build
      - run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  build-binaries:
    runs-on: ${{ matrix.os }}
    needs: publish-npm
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: linux-x64
            pkg-target: node22-linux-x64
          - os: ubuntu-24.04-arm
            target: linux-arm64
            pkg-target: node22-linux-arm64
          - os: macos-latest
            target: macos-arm64
            pkg-target: node22-macos-arm64
          - os: macos-13
            target: macos-x64
            pkg-target: node22-macos-x64
          - os: windows-latest
            target: windows-x64
            pkg-target: node22-win-x64
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm
      - run: npm ci
      - run: npm run build
      - name: Create standalone binary
        run: npx pkg dist/cli.js --target ${{ matrix.pkg-target }} --output savestate-${{ matrix.target }}
        continue-on-error: true
      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: savestate-${{ matrix.target }}
          path: savestate-${{ matrix.target }}*
          if-no-files-found: ignore

  create-release:
    runs-on: ubuntu-latest
    needs: build-binaries
    if: always() && needs.publish-npm.result == 'success'
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
        continue-on-error: true
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: artifacts/*
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    runs-on: ubuntu-latest
    needs: publish-npm
    if: vars.HOMEBREW_TAP_TOKEN != '' || secrets.HOMEBREW_TAP_TOKEN != ''
    steps:
      - name: Get tarball SHA256
        id: sha
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          TARBALL_URL="https://registry.npmjs.org/@savestate/cli/-/cli-${VERSION}.tgz"
          # Wait for npm CDN propagation
          sleep 10
          SHA256=$(curl -sL "$TARBALL_URL" | shasum -a 256 | cut -d' ' -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "url=$TARBALL_URL" >> $GITHUB_OUTPUT
      - uses: actions/checkout@v4
        with:
          repository: savestatedev/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap
      - name: Update formula
        run: |
          cat > homebrew-tap/Formula/savestate.rb << EOF
          class Savestate < Formula
            desc "Time Machine for AI â€” encrypted backup, restore, and migration for AI agent state"
            homepage "https://savestate.dev"
            url "${{ steps.sha.outputs.url }}"
            sha256 "${{ steps.sha.outputs.sha256 }}"
            license "MIT"

            depends_on "node"

            def install
              system "npm", "install", *std_npm_args
              bin.install_symlink Dir["#{libexec}/bin/*"]
            end

            test do
              assert_match "savestate", shell_output("#{bin}/savestate --help")
            end
          end
          EOF
      - name: Push formula update
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/savestate.rb
          git diff --cached --quiet && echo "No changes" || (git commit -m "Update savestate to v${{ steps.sha.outputs.version }}" && git push)
